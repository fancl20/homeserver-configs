---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build-push
  namespace: continuous
spec:
  params:
  - name: image
    type: string
  - name: base_tag
    type: string
    default: testing-20230725 # {"$imagepolicy": "flux-system:debian:tag"}
  workspaces:
  - name: dockerconfig
  tasks:
  - name: build-push
    taskRef:
      name: kaniko
    workspaces:
    - name: dockerconfig
      workspace: dockerconfig
    params:
    - name: IMAGE
      value: registry.local.d20.fan/fancl20/$(params.image)
    - name: CONTEXT
      value: git://github.com/fancl20/homeserver-configs.git#refs/heads/main
    - name: CONTEXT_SUB_PATH
      value: images/$(params.image)
    - name: EXTRA_ARGS
      value:
      - --build-arg
      - BASE_TAG=$(params.base_tag)
---
apiVersion: image.toolkit.fluxcd.io/v1beta2
kind: ImageRepository
metadata:
  name: debian
  namespace: flux-system
spec:
  image: docker.io/debian/snapshot
  interval: 1h
---
apiVersion: image.toolkit.fluxcd.io/v1beta2
kind: ImagePolicy
metadata:
  name: debian
  namespace: flux-system
spec:
  imageRepositoryRef:
    name: debian
  filterTags:
    pattern: '^testing-(?P<timestamp>.*)$'
    extract: '$timestamp'
  policy:
    alphabetical:
      order: asc
