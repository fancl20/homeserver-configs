{
   "apiVersion": "apps/v1",
   "kind": "Deployment",
   "metadata": {
      "annotations": {
         "kustomize.toolkit.fluxcd.io/substitute": "disabled"
      },
      "name": "registry",
      "namespace": "default"
   },
   "spec": {
      "replicas": 1,
      "selector": {
         "matchLabels": {
            "app.kubernetes.io/name": "registry"
         }
      },
      "strategy": {
         "rollingUpdate": {
            "maxSurge": 0,
            "maxUnavailable": "100%"
         }
      },
      "template": {
         "metadata": {
            "annotations": { },
            "labels": {
               "app.kubernetes.io/name": "registry"
            }
         },
         "spec": {
            "containers": [
               {
                  "env": [
                     {
                        "name": "OTEL_TRACES_EXPORTER",
                        "value": "none"
                     },
                     {
                        "name": "REGISTRY_LOG_LEVEL",
                        "value": "info"
                     }
                  ],
                  "image": "docker.io/library/registry",
                  "name": "registry",
                  "volumeMounts": [
                     {
                        "mountPath": "/var/lib/registry",
                        "name": "registry"
                     }
                  ]
               },
               {
                  "command": [
                     "/bin/sh",
                     "-c",
                     "#!/bin/sh\nset -e\n\nKEEP_TAGS=3\n\ncleanup_old_tags() {\n  repo_path=\"$1\"\n  tags_dir=\"$repo_path/_manifests/tags\"\n\n  if [ ! -d \"$tags_dir\" ]; then\n    echo \"No tags directory found at $tags_dir\"\n    return\n  fi\n\n  echo \"Processing repository: $repo_path\"\n\n  # Remove old tags using tail to skip the first KEEP_TAGS tags\n  ls -t \"$tags_dir\" 2>/dev/null | tail -n +$((KEEP_TAGS + 1)) | while read -r tag; do\n    if [ -n \"$tag\" ]; then\n      tag_path=\"$tags_dir/$tag\"\n      echo \"    Removing old tag: $tag\"\n      rm -rf \"$tag_path\"\n    fi\n  done\n}\n\nrun_cleanup() {\n  echo \"Starting registry cleanup at $(date)\"\n\n  for repo in /var/lib/registry/docker/registry/v2/repositories/*/*; do\n    if [ -d \"$repo\" ]; then\n      cleanup_old_tags \"$repo\"\n    fi\n  done\n\n  echo \"Running garbage collection...\"\n  registry garbage-collect /etc/distribution/config.yml --delete-untagged=true\n\n  echo \"Registry cleanup completed at $(date)\"\n}\n\nwhile true; do\n  run_cleanup\n  echo \"Sleeping for 7 days until next cleanup...\"\n  sleep 604800\ndone\n"
                  ],
                  "image": "docker.io/library/registry",
                  "name": "cleanup",
                  "volumeMounts": [
                     {
                        "mountPath": "/var/lib/registry",
                        "name": "registry"
                     }
                  ]
               }
            ],
            "securityContext": {
               "fsGroup": 1000,
               "fsGroupChangePolicy": "OnRootMismatch",
               "runAsGroup": 1000,
               "runAsUser": 1000
            },
            "serviceAccountName": "registry",
            "volumes": [
               {
                  "name": "registry",
                  "persistentVolumeClaim": {
                     "claimName": "registry"
                  }
               }
            ]
         }
      }
   }
}
